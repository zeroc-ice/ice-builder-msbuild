<?xml version="1.0" encoding="utf-8"?>
<!-- Copyright (c) 2009-2017 ZeroC, Inc. All rights reserved. -->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

    <ItemGroup>
        <PropertyPageSchema Include="$(MSBuildThisFileDirectory)ProjectItemsSchema.xaml" />
        <PropertyPageSchema Include="$(MSBuildThisFileDirectory)SliceCompile.xaml">
            <Context>File;BrowseObject</Context>
        </PropertyPageSchema>
        <PropertyPageSchema Include="$(MSBuildThisFileDirectory)SliceCompile.CSharpProject.xaml">
            <Context>Project</Context>
        </PropertyPageSchema>
    </ItemGroup>

    <ItemGroup>
        <Compile Include="@(SliceCompile->'$(SliceCompileOutputDir)\%(Filename).cs')"
                 Exclude="@(Compile)" />
    </ItemGroup>

    <!-- These capavility is used to apply the Slice property page designer -->
    <ItemGroup>
        <ProjectCapability Include="SliceCompile" />
    </ItemGroup>

    <Target Name="SliceCompile" BeforeTargets="CoreCompile;XamlPreCompile">

        <Error Text="Ice Installation not detected. Please update Ice Home settings'"
               Condition="'$(IceHome)' == ''" />

        <Error Text="The Ice Builder requires Ice Version 3.6 or later but $(IceHome) version is $(IceVersion.Replace('.51', 'b'))"
               Condition="'$(IceVersion)' == '' Or '$(IceIntVersion)' == '' Or '$(IceIntVersion)' &lt; '30600' Or '$(IceIntVersion)' == '30651'" />

        <MakeDir Directories="$(SliceCompileOutputDir)"/>

        <WriteLinesToFile
            File="$(IntermediateOutputPath)\SliceCompile.command.log"
            Lines="Ice Home: $(IceHome);
                   Ice Tools Path: $(IceToolsPath);
                   Output Dir: $(SliceCompileOutputDir);
                   Include Directories: $(SliceCompileIncludeDirectories);
                   Additional Options: $(SliceCompileAdditionalOptions)"
            Overwrite="true"/>

        <!-- First we check dependencies and decide what must be rebuild -->
        <Slice2CSharpDependTask
            OutputDir             = "$(SliceCompileOutputDir)"
            WorkingDirectory      = "$(MSBuildProjectDirectory)"
            IceToolsPath          = "$(IceToolsPath)"
            DependFile            = "$(IntermediateOutputPath)\SliceCompile.d"
            CommandLog            = "$(IntermediateOutputPath)\SliceCompile.command.log"
            Sources               = "@(SliceCompile)">

            <Output
                ItemName          = "_SliceCompile"
                TaskParameter     = "ComputedSources"/>

            <Output
                PropertyName      = "_SliceCompileUdateDepends"
                TaskParameter     = "UpdateDepends"/>

        </Slice2CSharpDependTask>

        <!-- Compile the Slice files to produce the generated code -->
        <Slice2CSharpTask
            IceHome               = "$(IceHome)"
            IceToolsPath          = "$(IceToolsPath)"
            OutputDir             = "$(SliceCompileOutputDir)"
            WorkingDirectory      = "$(MSBuildProjectDirectory)"
            IncludeDirectories    = "$(SliceCompileIncludeDirectories)"
            AdditionalOptions     = "$(SliceCompileAdditionalOptions)"
            DependFile            = "$(IntermediateOutputPath)\SliceCompile.d"
            Sources               = "@(_SliceCompile)"
            Condition             = "'%(_SliceCompile.BuildRequired)' == 'True'"/>

        <!-- Update the dependencies -->
        <Slice2CSharpTask
            IceHome               = "$(IceHome)"
            IceToolsPath          = "$(IceToolsPath)"
            OutputDir             = "$(SliceCompileOutputDir)"
            WorkingDirectory      = "$(MSBuildProjectDirectory)"
            IncludeDirectories    = "$(SliceCompileIncludeDirectories)"
            AdditionalOptions     = "$(SliceCompileAdditionalOptions)"
            DependFile            = "$(IntermediateOutputPath)\SliceCompile.d"
            Sources               = "@(_SliceCompile)"
            Depend                = "true"
            Condition             = "'$(_SliceCompileUdateDepends)' == 'True'"/>
    </Target>

    <Target Name="SliceCompileClean" BeforeTargets="Clean">
        <Delete Files="@(SliceCompile->'$(SliceCompileOutputDir)\%(Filename).cs')"/>
        <Delete Files="$(IntermediateOutputPath)\SliceCompile.d"/>
        <Delete Files="$(IntermediateOutputPath)\SliceCompile.command.log"/>
        <Delete Files="$(IntermediateOutputPath)\SliceCompile.command.0.log"/>
    </Target>
</Project>
