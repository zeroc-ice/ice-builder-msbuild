<?xml version="1.0" encoding="utf-8"?>
<!-- Copyright (c) 2009-2017 ZeroC, Inc. All rights reserved. -->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

    <!-- Import SliceCompile schema -->
    <ItemGroup>
        <PropertyPageSchema Include="$(MSBuildThisFileDirectory)$(MSBuildThisFileName).xml" >
            <Context>Project</Context>
        </PropertyPageSchema>
        <AvailableItemName Include="SliceCompile" />
    </ItemGroup>

    <Target Name="SliceCompile" BeforeTargets="CoreCompile;XamlPreCompile">

        <Error Text="Ice Installation not detected. Please update Ice Home settings'"
               Condition="'$(IceHome)' == ''" />

        <Error Text="The selected C++ Runtime Library is not supported by Ice; Ice requires /MD or /MDd."
               Condition="'%(ClCompile.RuntimeLibrary)' != 'MultiThreadedDebugDLL' And
                          '%(ClCompile.RuntimeLibrary)' != 'MultiThreadedDLL' "/>

        <Error Text="The Ice Builder requires Ice Version 3.6 or later but $(IceHome) version is $(IceVersion.Replace('.51', 'b'))"
               Condition="'$(IceVersion)' == '' Or '$(IceIntVersion)' == '' Or '$(IceIntVersion)' &lt; '30600' Or '$(IceIntVersion)' == '30651'" />

        <ItemGroup>
            <Compile Include="@(SliceCompile->'$(SliceCompileOutputDir)\%(Filename).cs')"
                     Exclude="@(Compile)" />
        </ItemGroup>

        <MakeDir Directories="$(SliceCompileOutputDir)"/>

        <WriteLinesToFile
            File="$(SliceCompileOutputDir)\SliceCompile.command.log"
            Lines="Ice Home: $(IceHome);
                   Ice Tools Path: $(IceToolsPath);
                   Output Dir: $(SliceCompileOutputDir);
                   Include Directories: $(SliceCompileIncludeDirectories);
                   Additional Options: $(SliceCompileAdditionalOptions)"
            Overwrite="true"/>

        <!-- First we check dependencies and decide what must be rebuild -->
        <Slice2CSharpDependTask
            OutputDir             = "$(SliceCompileOutputDir)"
            WorkingDirectory      = "$(MSBuildProjectDirectory)"
            SliceCompiler         = "$(IceToolsPath)/slice2cs.exe"
            DependFile            = "$(SliceCompileOutputDir)\SliceCompile.d"
            CommandLog            = "$(SliceCompileOutputDir)\SliceCompile.command.log"
            Sources               = "@(SliceCompile)">

            <Output
                ItemName          = "_SliceCompile"
                TaskParameter     = "ComputedSources"/>

            <Output
                PropertyName      = "_SliceCompileUdateDepends"
                TaskParameter     = "UpdateDepends"/>

        </Slice2CSharpDependTask>

        <!-- Compile the Slice files to produce the generated code -->
        <Slice2CSharpTask
            IceHome               = "$(IceHome)"
            IceToolsPath          = "$(IceToolsPath)"
            OutputDir             = "$(SliceCompileOutputDir)"
            WorkingDirectory      = "$(MSBuildProjectDirectory)"
            IncludeDirectories    = "$(SliceCompileIncludeDirectories)"
            AdditionalOptions     = "$(SliceCompileAdditionalOptions)"
            DependFile            = "$(SliceCompileOutputDir)\SliceCompile.d"
            Sources               = "@(_SliceCompile)"
            Condition             = "'%(_SliceCompile.BuildRequired)' == 'True'"/>

        <!-- Update the dependencies -->
        <Slice2CSharpTask
            IceHome               = "$(IceHome)"
            IceToolsPath          = "$(IceToolsPath)"
            OutputDir             = "$(SliceCompileOutputDir)"
            WorkingDirectory      = "$(MSBuildProjectDirectory)"
            IncludeDirectories    = "$(SliceCompileIncludeDirectories)"
            AdditionalOptions     = "$(SliceCompileAdditionalOptions)"
            DependFile            = "$(SliceCompileOutputDir)\SliceCompile.d"
            Sources               = "@(_SliceCompile)"
            Depend                = "true"
            Condition             = "'$(_SliceCompileUdateDepends)' == 'True'"/>
    </Target>

    <Target Name="SliceCompileClean" BeforeTargets="Clean">
        <Delete Files="$(SliceCompileOutputDir)\%(SliceCompile.FileName).cs"/>
        <Delete Files="$(SliceCompileOutputDir)\SliceCompile.d"/>
        <Delete Files="$(SliceCompileOutputDir)\SliceCompile.command.log"/>
        <Delete Files="$(SliceCompileOutputDir)\SliceCompile.command.0.log"/>
    </Target>
</Project>
